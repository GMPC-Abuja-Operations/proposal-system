<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldenmuv Proposal Management System</title>
    <link rel="icon" href="Picture1.png" type="image/png">
    <link rel="shortcut icon" href="Picture1.png" type="image/png">
    <link rel="apple-touch-icon" href="Picture1.png">
    <style>
        :root {
            --primary: #D4AF37;
            --primary-dark: #B8972E;
            --primary-light: rgba(212, 175, 55, 0.1);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #F5F0E1;
            --dark: #4A2C2A;
            --gray: #6B5A5A;
            --gray-light: #a8a8a8;
            --border: #D4AF37;
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(74, 44, 42, 0.08);
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(74, 44, 42, 0.12);
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }
        
        header {
            background: linear-gradient(135deg, #D4AF37, #B8972E);
            color: white;
            padding: 40px 20px 30px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .logo {
            position: absolute;
            top: 20px;
            left: 30px;
            height: 90px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }
        
        header h1 { 
            margin: 0; 
            font-size: 2.8rem; 
            font-weight: 800; 
            letter-spacing: 1px; 
            text-shadow: 1px 1px 4px rgba(0,0,0,0.3); 
        }
        
        /* User Selection Banner */
        .user-select-banner {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid var(--primary);
            padding: 15px 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .user-select-banner.show {
            display: flex;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .user-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .change-user-btn {
            background: none;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .change-user-btn:hover {
            background: var(--primary-light);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--light);
        }
        
        .tab-btn {
            flex: 1;
            padding: 18px;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            color: var(--dark);
            font-weight: 600;
            background: white;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }
        
        .tab-badge {
            background: var(--primary);
            color: var(--dark);
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .keyboard-hint {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-left: 5px;
        }
        
        /* Tab Content */
        .tab-panel {
            display: none;
            padding: 0;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Form Cards Layout */
        .form-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: var(--dark);
            margin: 0 0 25px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 1.3rem;
        }
        
        /* Card Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .form-card {
            background: var(--card-bg);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .form-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 44, 42, 0.12);
            border-color: rgba(212, 175, 55, 0.4);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-icon {
            width: 36px;
            height: 36px;
            background: var(--primary-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 1.2rem;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 22px;
            position: relative;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .required-star {
            color: var(--danger);
            margin-left: 3px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            color: var(--dark);
            background: white;
            font-family: inherit;
        }
        
        input:hover, select:hover, textarea:hover {
            border-color: var(--primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.25);
        }
        
        .input-hint {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 6px;
            display: block;
            line-height: 1.4;
        }
        
        .char-count {
            font-size: 0.85rem;
            color: var(--gray);
            text-align: right;
            margin-top: 4px;
        }
        
        .char-count.warning {
            color: var(--warning);
        }
        
        .char-count.danger {
            color: var(--danger);
        }
        
        /* Task Cards Grid */
        .tasks-container {
            padding: 30px;
        }
        
        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .tasks-title {
            font-size: 1.5rem;
            color: var(--dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--gray);
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: var(--dark);
            font-weight: 600;
            border-color: var(--primary);
        }
        
        .filter-btn:hover:not(.active) {
            background: var(--primary-light);
            color: var(--dark);
        }
        
        .search-box {
            position: relative;
            min-width: 250px;
        }
        
        .search-box input {
            padding-left: 40px;
            padding-right: 40px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 4px;
            display: none;
        }
        
        .clear-search:hover {
            color: var(--danger);
        }
        
        /* Task Cards */
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .task-card {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 44, 42, 0.15);
        }
        
        .task-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        
        .task-card.urgent {
            border-color: var(--danger);
            border-left-width: 4px;
        }
        
        .task-card.assigned-to-me {
            border-color: var(--primary);
            border-left-width: 4px;
        }
        
        .task-card.stale {
            opacity: 0.8;
            border-style: dashed;
        }
        
        .task-priority {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px 12px;
            border-bottom-left-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-urgent {
            background: var(--danger);
            color: white;
        }
        
        .priority-soon {
            background: var(--warning);
            color: var(--dark);
        }
        
        .priority-normal {
            background: var(--primary);
            color: var(--dark);
        }
        
        .task-client {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .task-amount {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
            margin: 5px 0;
        }
        
        .task-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .task-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--gray);
        }
        
        .task-detail-icon {
            color: var(--primary);
            font-size: 1rem;
        }
        
        .task-status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .status-ready { background: rgba(40, 167, 69, 0.1); color: #28a745; }
        .status-sent { background: rgba(0, 123, 255, 0.1); color: #007bff; }
        .status-draft { background: rgba(108, 117, 125, 0.1); color: #6c757d; }
        
        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--gray);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn:hover {
            background: var(--primary-light);
            color: var(--dark);
            border-color: var(--primary);
        }
        
        .action-btn.primary {
            background: var(--primary);
            color: var(--dark);
            border-color: var(--primary-dark);
            font-weight: 600;
        }
        
        .action-btn.primary:hover {
            background: var(--primary-dark);
            color: white;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Buttons */
        button {
            padding: 14px 24px;
            background: var(--primary);
            color: var(--dark);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(74, 44, 42, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover { 
            background: var(--primary-dark); 
            color: white;
            transform: translateY(-1px);
        }
        
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: white;
            border: 1px solid var(--border);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Banners & Messages */
        .banner {
            padding: 18px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            animation: slideIn 0.3s ease;
            border: 1px solid;
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .success { 
            background: rgba(40, 167, 69, 0.1); 
            color: #155724; 
            border-color: rgba(40, 167, 69, 0.3);
        }
        
        .error { 
            background: rgba(220, 53, 69, 0.1); 
            color: #721c24; 
            border-color: rgba(220, 53, 69, 0.3); 
        }
        
        .warning { 
            background: rgba(255, 193, 7, 0.1); 
            color: #856404; 
            border-color: rgba(255, 193, 7, 0.3); 
        }
        
        .info { 
            background: rgba(23, 162, 184, 0.1); 
            color: #0c5460; 
            border-color: rgba(23, 162, 184, 0.3); 
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .loading::after {
            content: ' ‚è≥';
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* Error States */
        .error-field {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25) !important;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 6px;
            display: none;
        }
        
        /* Predictive Suggestions */
        .suggestions-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border);
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        .suggestion-item:hover {
            background: var(--primary-light);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        /* Partner Section */
        #partner-section {
            margin: 30px 0;
            padding: 25px;
            background: var(--primary-light);
            border-radius: 12px;
            border: 2px dashed var(--primary);
        }
        
        /* Draft Notice */
        .draft-notice {
            background: var(--primary-light);
            border: 1px dashed var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease;
        }
        
        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--dark);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                border-radius: 12px;
                margin: 10px;
            }
            
            header {
                padding: 30px 20px;
            }
            
            .logo {
                position: relative;
                top: 0;
                left: 0;
                margin: 0 auto 15px;
                display: block;
                height: 70px;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 16px;
                justify-content: flex-start;
                padding-left: 30px;
            }
            
            .card-grid,
            .tasks-grid {
                grid-template-columns: 1fr;
            }
            
            .form-section,
            .tasks-container {
                padding: 20px;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .user-select-banner {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .task-details {
                grid-template-columns: 1fr;
            }
            
            .task-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Print styles */
        @media print {
            .tabs,
            .filter-controls,
            .action-btn,
            button:not(.print-btn) {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                border: 1px solid #ccc;
            }
            
            .task-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <!-- User Selection Modal -->
    <div id="user-select-modal" class="user-select-banner show">
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">üë§</div>
            <div>
                <div class="user-name" id="current-user-name">Select your name to begin</div>
                <div style="font-size: 0.85rem; color: var(--gray);">Your tasks and notifications will be personalized</div>
            </div>
        </div>
        <div>
            <button class="change-user-btn" onclick="showUserSelector()">Change User</button>
        </div>
    </div>

    <!-- User Selection Dialog -->
    <div id="user-select-dialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: var(--dark); text-align: center;">üëã Welcome to GPMS</h2>
            <p style="color: var(--gray); text-align: center; margin-bottom: 30px;">Select your name to see personalized tasks and receive notifications</p>
            
            <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px;">
                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';" 
                       onmouseout="this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.background='transparent';">
                    <input type="radio" name="user" value="staff1" style="margin-right: 15px;" onclick="selectUser('staff1', 'Mr. Immanuelson Sam')">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">Mr. Immanuelson Sam</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Managing Partner</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';" 
                       onmouseout="this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.background='transparent';">
                    <input type="radio" name="user" value="staff2" style="margin-right: 15px;" onclick="selectUser('staff2', 'Ms. Joan Alaribe')">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">Ms. Joan Alaribe</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Associate</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';" 
                       onmouseout="this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.background='transparent';">
                    <input type="radio" name="user" value="staff3" style="margin-right: 15px;" onclick="selectUser('staff3', 'Mr. Emmanuel Agama')">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">Mr. Emmanuel Agama</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Associate</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';" 
                       onmouseout="this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.background='transparent';">
                    <input type="radio" name="user" value="staff4" style="margin-right: 15px;" onclick="selectUser('staff4', 'Mr. Matthew Nnaji')">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">Mr. Matthew Nnaji</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Associate</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid rgba(212, 175, 55, 0.3); border-radius: 10px; cursor: pointer; transition: all 0.2s;" 
                       onmouseover="this.style.borderColor='var(--primary)'; this.style.background='var(--primary-light)';" 
                       onmouseout="this.style.borderColor='rgba(212, 175, 55, 0.3)'; this.style.background='transparent';">
                    <input type="radio" name="user" value="staff5" style="margin-right: 15px;" onclick="selectUser('staff5', 'Mr. Peter Esiole')">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">Mr. Peter Esiole</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">Partner</div>
                    </div>
                </label>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button onclick="rememberUserChoice()" style="flex: 1; background: var(--primary); color: var(--dark);">
                    <span>‚úÖ</span> Remember Me & Continue
                </button>
                <button onclick="continueWithoutSaving()" style="flex: 1; background: white; border: 1px solid var(--border); color: var(--dark);">
                    <span>üöÄ</span> Continue Without Saving
                </button>
            </div>
            
            <p style="font-size: 0.85rem; color: var(--gray); text-align: center; margin-top: 20px;">
                <label style="display: inline-flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="remember-checkbox" checked style="margin-right: 8px;">
                    Remember my choice on this computer
                </label>
            </p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <header>
            <img src="Picture1.png" alt="Goldenmuv Logo" class="logo">
            <h1>GPMS</h1>
            <p style="margin: 8px 0 0; font-size: 1.25rem; font-weight: 500; opacity: 0.95; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">Goldenmuv Proposal Management System</p>
        </header>

        <!-- Auto-save Indicator -->
        <div id="auto-save-indicator" class="auto-save-indicator">
            <span>üíæ</span>
            <span id="auto-save-text">Draft saved</span>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('new')" id="tab-new">
                üìã New Opportunity
                <span class="keyboard-hint">Ctrl+1</span>
            </button>
            <button class="tab-btn" onclick="showTab('update')" id="tab-update">
                üîÑ Update Task
                <span id="update-badge" class="tab-badge" style="display: none;">0</span>
                <span class="keyboard-hint">Ctrl+2</span>
            </button>
        </div>

        <!-- New Opportunity Form -->
        <div id="new-tab" class="tab-panel active">
            <div class="form-section">
                <!-- Draft Notice -->
                <div id="draft-notice" class="draft-notice" style="display: none;">
                    <div>
                        <span style="font-weight: 600;">üíæ Draft restored</span>
                        <div style="font-size: 0.9rem; color: var(--gray); margin-top: 4px;">
                            Continue where you left off. Auto-save is enabled.
                        </div>
                    </div>
                    <button onclick="clearDraft()" style="padding: 6px 12px; font-size: 0.9rem;">
                        Clear Draft
                    </button>
                </div>

                <!-- Quick Stats -->
                <div class="quick-stats" id="new-opp-stats">
                    <div class="stat-card">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value" id="week-count">0</div>
                        <div class="stat-label">Opportunities</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average Value</div>
                        <div class="stat-value" id="avg-value">‚Ç¶0</div>
                        <div class="stat-label">Per Opportunity</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Success Rate</div>
                        <div class="stat-value" id="success-rate">0%</div>
                        <div class="stat-label">Last 30 Days</div>
                    </div>
                </div>

                <!-- Form Cards -->
                <div class="card-grid">
                    <!-- Client Card -->
                    <div class="form-card">
                        <div class="card-header">
                            <h3 class="card-title"><span>üë§</span> Client Information</h3>
                            <div class="card-icon">üè¢</div>
                        </div>
                        <form id="new-form">
                            <input type="hidden" name="formType" value="newOpportunity">
                            
                            <div class="form-group">
                                <label for="clientName">Client Name <span class="required-star">*</span></label>
                                <input type="text" id="clientName" name="clientName" required 
                                       placeholder="e.g., ABC Corporation Limited"
                                       oninput="showClientSuggestions(this.value)">
                                <div class="input-hint">Enter the full legal name of the client company</div>
                                <div id="clientName-suggestions" class="suggestions-box"></div>
                                <span class="error-message" id="clientName-error">Client name is required</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="source">Opportunity Source <span class="required-star">*</span></label>
                                <select id="source" name="source" required>
                                    <option value="">Select source...</option>
                                    <option value="existing">üè¢ Existing Client</option>
                                    <option value="referral">ü§ù Referral</option>
                                    <option value="cold">üìû Cold Outreach</option>
                                    <option value="partner">üåê Partner Network</option>
                                    <option value="other">üîÄ Other</option>
                                </select>
                                <div class="input-hint">How did this opportunity come to us?</div>
                                <span class="error-message" id="source-error">Please select a source</span>
                            </div>
                        </form>
                    </div>

                    <!-- Opportunity Card -->
                    <div class="form-card">
                        <div class="card-header">
                            <h3 class="card-title"><span>üí∞</span> Opportunity Details</h3>
                            <div class="card-icon">üéØ</div>
                        </div>
                        <div class="form-group">
                            <label for="description">Description <span class="required-star">*</span></label>
                            <textarea id="description" name="description" required rows="4" 
                                      placeholder="Describe the opportunity in detail. Include scope, requirements, and client needs..."
                                      oninput="updateCharCount(this, 'description-count', 500)"></textarea>
                            <div class="char-count" id="description-count">0/500 characters</div>
                            <div class="input-hint">Be specific about deliverables and client expectations</div>
                            <span class="error-message" id="description-error">Description is required (min. 20 characters)</span>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nairaEstimateDisplay">Estimated Value <span class="required-star">*</span></label>
                                <input type="text" id="nairaEstimateDisplay" required 
                                       placeholder="e.g., 5,000,000">
                                <input type="hidden" id="nairaEstimate" name="nairaEstimate">
                                <div class="input-hint">Last similar project: <span id="similar-project-value">‚Ç¶0</span></div>
                                <span class="error-message" id="nairaEstimate-error">Please enter a valid amount (min. ‚Ç¶50,000)</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="dueDate">Due Date <span class="required-star">*</span></label>
                                <input type="date" id="dueDate" name="dueDate" required>
                                <div class="input-hint" id="due-date-hint">Select a date</div>
                                <span class="error-message" id="dueDate-error">Please select a valid future date</span>
                            </div>
                        </div>
                    </div>

                    <!-- Team Card -->
                    <div class="form-card">
                        <div class="card-header">
                            <h3 class="card-title"><span>üë•</span> Team Assignment</h3>
                            <div class="card-icon">ü§ù</div>
                        </div>
                        <div class="form-group">
                            <label for="assignedStaff">Primary Consultant <span class="required-star">*</span></label>
                            <select id="assignedStaff" name="assignedStaff" required>
                                <option value="">Select consultant...</option>
                                <option value="staff2">üë©‚Äçüíº Ms. Joan Alaribe</option>
                                <option value="staff3">üë®‚Äçüíº Mr. Emmanuel Agama</option>
                                <option value="staff4">üë®‚Äçüíº Mr. Matthew Nnaji</option>
                            </select>
                            <div class="input-hint">This person will lead the proposal development</div>
                            <span class="error-message" id="assignedStaff-error">Please select a Primary Consultant</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="followupPerson">Client Relationship Manager <span class="required-star">*</span></label>
                            <select id="followupPerson" name="followupPerson" required>
                                <option value="">Select manager...</option>
                                <option value="staff1">üë®‚Äçüíº Mr. Immanuelson Sam</option>
                                <option value="staff4">üë®‚Äçüíº Mr. Matthew Nnaji</option>
                                <option value="staff5">üë®‚Äçüíº Mr. Peter Esiole</option>
                            </select>
                            <div class="input-hint">This person will manage client communication</div>
                            <span class="error-message" id="followupPerson-error">Please select a Relationship Manager</span>
                        </div>
                        
                        <button type="button" onclick="submitNewForm()" style="width: 100%; margin-top: 20px;">
                            <span>üöÄ</span> Submit Opportunity
                            <span class="keyboard-hint">Ctrl+Enter</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Task Form -->
        <div id="update-tab" class="tab-panel">
            <div class="tasks-container">
                <!-- Quick Stats -->
                <div class="quick-stats" id="task-stats">
                    <div class="stat-card">
                        <div class="stat-label">Your Tasks</div>
                        <div class="stat-value" id="my-task-count">0</div>
                        <div class="stat-label">Require Attention</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Due Soon</div>
                        <div class="stat-value" id="due-soon-count">0</div>
                        <div class="stat-label">Next 7 Days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Value</div>
                        <div class="stat-value" id="total-value">‚Ç¶0</div>
                        <div class="stat-label">Active Pipeline</div>
                    </div>
                </div>

                <!-- Tasks Header -->
                <div class="tasks-header">
                    <h2 class="tasks-title"><span>üìã</span> Your Tasks</h2>
                    <div class="filter-controls">
                        <div class="filter-btn-group">
                            <button class="filter-btn active" onclick="filterTasks('my-tasks')">My Tasks</button>
                            <button class="filter-btn" onclick="filterTasks('team-tasks')">Team Tasks</button>
                            <button class="filter-btn" onclick="filterTasks('all-tasks')">All Tasks</button>
                        </div>
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="task-search" placeholder="Search clients, status, or amount..." 
                                   oninput="searchTasks(this.value)">
                            <button class="clear-search" onclick="clearSearch()" id="clear-search-btn">‚úï</button>
                        </div>
                        <button onclick="refreshTasks()" style="padding: 8px 16px;">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>

                <!-- Tasks Grid -->
                <div id="tasks-grid" class="tasks-grid">
                    <!-- Tasks will be loaded here -->
                    <div style="text-align: center; grid-column: 1 / -1; padding: 40px; color: var(--gray);">
                        <div style="font-size: 3rem; margin-bottom: 20px;">üìã</div>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">Loading your tasks...</h3>
                        <p>Please select your name above to see personalized tasks</p>
                    </div>
                </div>

                <!-- Selected Task Form -->
                <div id="selected-task-form" style="display: none;">
                    <div class="form-card">
                        <div class="card-header">
                            <h3 class="card-title"><span>‚úèÔ∏è</span> Update Task</h3>
                            <div class="card-icon">üîÑ</div>
                        </div>
                        
                        <form id="update-form">
                            <input type="hidden" name="formType" value="updateTask">
                            <input type="hidden" id="taskId" name="taskId">
                            
                            <div class="form-group">
                                <label for="selected-client">Client</label>
                                <input type="text" id="selected-client" disabled style="background: var(--primary-light);">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="status">Status <span class="required-star">*</span></label>
                                    <select id="status" name="status" required>
                                        <option value="">Select status...</option>
                                        <option value="draft">üìù Draft</option>
                                        <option value="ready_for_review">‚úÖ Ready for Review</option>
                                        <option value="sent_to_client">üì§ Sent to Client</option>
                                        <option value="client_review">üëÄ Client Review</option>
                                        <option value="revise">üîß Revise</option>
                                    </select>
                                    <span class="error-message" id="status-error">Please select a status</span>
                                </div>
                                
                                <div class="form-group">
                                    <label for="nextFollowupDate">Next Follow-up</label>
                                    <input type="date" id="nextFollowupDate" name="nextFollowupDate">
                                    <div class="input-hint">Schedule next client contact</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="notes">Notes & Comments</label>
                                <textarea id="notes" name="notes" rows="3" 
                                          placeholder="Add updates, client feedback, or next steps..."
                                          oninput="updateCharCount(this, 'notes-count', 1000)"></textarea>
                                <div class="char-count" id="notes-count">0/1000 characters</div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="margin: 20px 0; padding: 15px; background: var(--primary-light); border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 10px; color: var(--dark);">‚ö° Quick Actions</div>
                                <div class="task-actions">
                                    <button type="button" class="action-btn primary" onclick="quickAction('sent')">
                                        <span>üì§</span> Mark as Sent
                                    </button>
                                    <button type="button" class="action-btn" onclick="quickAction('review')">
                                        <span>‚úÖ</span> Ready for Review
                                    </button>
                                    <button type="button" class="action-btn" onclick="quickAction('followup')">
                                        <span>üìÖ</span> Schedule Follow-up
                                    </button>
                                    <button type="button" class="action-btn" onclick="openGoogleFormDirect()">
                                        <span>üìé</span> Upload Files
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <button type="button" onclick="submitUpdateForm()" style="flex: 1;">
                                    <span>üíæ</span> Update Task
                                </button>
                                <button type="button" class="btn-secondary" onclick="deselectTask()" style="flex: 1;">
                                    <span>‚Üê</span> Back to Tasks
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Partner Section -->
                    <div id="partner-section" style="margin-top: 30px;">
                        <button type="button" onclick="togglePartnerSection()" 
                                style="width: 100%; background: var(--primary-light); border: 2px solid var(--primary); color: var(--dark); padding: 12px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span>üîì</span> Partner Actions (Close Task)
                        </button>
                        
                        <div id="partner-actions" style="display: none; margin-top: 20px; padding: 25px; background: var(--primary-light); border-radius: 12px; border: 2px dashed var(--primary);">
                            <h3 style="color: var(--dark); margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <span>üîí</span> Finalize Opportunity
                            </h3>
                            
                            <div style="background: white; padding: 20px; border-radius: 8px;">
                                <div class="form-group">
                                    <label for="finalStatus">Final Outcome <span class="required-star">*</span></label>
                                    <select id="finalStatus" name="finalStatus" onchange="toggleCloseFields()">
                                        <option value="">Select outcome...</option>
                                        <option value="won">üéâ Won</option>
                                        <option value="lost">üìâ Lost</option>
                                        <option value="noresponse">‚è≥ No Response</option>
                                    </select>
                                </div>
                                
                                <div id="close-won-fields" style="display: none; margin: 20px 0;">
                                    <div class="form-group">
                                        <label for="actualValue">‚Ç¶ Actual Value (if Won) <span class="required-star">*</span></label>
                                        <input type="number" id="actualValue" name="actualValue" min="0" step="1000" placeholder="e.g., 4500000">
                                        <div class="input-hint">Final agreed amount with client</div>
                                    </div>
                                </div>
                                
                                <div id="close-lost-fields" style="display: none; margin: 20px 0;">
                                    <div class="form-group">
                                        <label for="lossReason">Loss Reason <span class="required-star">*</span></label>
                                        <select id="lossReason" name="lossReason">
                                            <option value="">Select reason...</option>
                                            <option value="price">üí∞ Price</option>
                                            <option value="competitor">üèÜ Competitor</option>
                                            <option value="timing">‚è∞ Timing</option>
                                            <option value="scope">üéØ Scope Mismatch</option>
                                            <option value="other">üîÄ Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="lossNotes">Loss Details</label>
                                        <textarea id="lossNotes" name="lossNotes" rows="2" placeholder="Additional details about why we lost..."></textarea>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="submitCloseTask()" style="width: 100%; background: var(--primary); color: var(--dark); padding: 14px; font-weight: 600; border-radius: 8px;">
                                    <span>üîí</span> Confirm Close Task
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Feedback Banners -->
        <div id="success-banner" class="banner success" style="display:none;"></div>
        <div id="error-banner" class="banner error" style="display:none;"></div>
        <div id="info-banner" class="banner info" style="display:none;"></div>
        <div id="loading" class="loading">Processing...</div>
    </div>

    <script>
        // === CONFIGURATION ===
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxXnezA7i4xDyN_EitNIGi3g0Pv4dDgAFJV96wVHxvQqx3hjt43Rcwj_S4AC5CkC7Fy/exec';
        
        // Global state
        let currentUser = null;
        let currentUserName = '';
        let allTasks = [];
        let filteredTasks = [];
        let selectedTaskId = null;
        let autoSaveTimer = null;
        let lastSaveTime = null;
        let draftData = null;

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log('GPMS Initializing...');
            
            // Set minimum dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dueDate').min = today;
            document.getElementById('nextFollowupDate').min = today;
            
            // Update due date hint
            updateDueDateHint();
            document.getElementById('dueDate').addEventListener('change', updateDueDateHint);
            
            // Check for saved user
            checkSavedUser();
            
            // Initialize keyboard shortcuts
            initKeyboardShortcuts();
            
            // Load form draft
            loadFormDraft();
            
            // Initialize stats
            updateStats();
            
            // Setup auto-save
            setupAutoSave();
        });

        // === USER MANAGEMENT ===
        function checkSavedUser() {
            const savedUser = localStorage.getItem('gpms_user');
            const savedUserName = localStorage.getItem('gpms_user_name');
            const rememberMe = localStorage.getItem('gpms_remember_me') === 'true';
            
            if (rememberMe && savedUser && savedUserName) {
                currentUser = savedUser;
                currentUserName = savedUserName;
                updateUserInterface();
                showTab('new');
                loadTasks();
            } else {
                showUserSelector();
            }
        }

        function showUserSelector() {
            document.getElementById('user-select-dialog').style.display = 'flex';
        }

        function selectUser(userId, userName) {
            currentUser = userId;
            currentUserName = userName;
            
            // Update radio buttons
            document.querySelectorAll('input[name="user"]').forEach(radio => {
                radio.checked = radio.value === userId;
            });
        }

        function rememberUserChoice() {
            const remember = document.getElementById('remember-checkbox').checked;
            
            if (remember && currentUser) {
                localStorage.setItem('gpms_user', currentUser);
                localStorage.setItem('gpms_user_name', currentUserName);
                localStorage.setItem('gpms_remember_me', 'true');
            }
            
            document.getElementById('user-select-dialog').style.display = 'none';
            updateUserInterface();
            
            if (currentUser) {
                showTab('new');
                loadTasks();
                showNotification('info', `Welcome, ${currentUserName.split(' ')[1]}!`, 3000);
            }
        }

        function continueWithoutSaving() {
            if (!currentUser) {
                showNotification('error', 'Please select a user first', 3000);
                return;
            }
            
            document.getElementById('user-select-dialog').style.display = 'none';
            updateUserInterface();
            
            if (currentUser) {
                showTab('new');
                loadTasks();
                showNotification('info', `Welcome, ${currentUserName.split(' ')[1]}! (Session only)`, 3000);
            }
        }

        function updateUserInterface() {
            const banner = document.getElementById('user-select-modal');
            const avatar = document.getElementById('user-avatar');
            const nameDisplay = document.getElementById('current-user-name');
            
            if (currentUser && currentUserName) {
                banner.classList.add('show');
                
                // Set avatar initials
                const initials = currentUserName.split(' ').map(n => n[0]).join('').toUpperCase();
                avatar.textContent = initials;
                nameDisplay.textContent = currentUserName;
                
                // Update tab badge
                updateTaskBadge();
            } else {
                banner.classList.remove('show');
            }
        }

        // === TAB MANAGEMENT ===
        function showTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab-panel').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            // Load tasks if showing update tab
            if (tabName === 'update' && currentUser) {
                loadTasks();
            }
            
            // Update stats
            updateStats();
        }

        // === TASK CARDS SYSTEM ===
        async function loadTasks() {
            if (!currentUser) {
                showNotification('warning', 'Please select your name first', 3000);
                return;
            }
            
            const tasksGrid = document.getElementById('tasks-grid');
            const selectedForm = document.getElementById('selected-task-form');
            
            // Show loading state
            tasksGrid.innerHTML = `
                <div style="text-align: center; grid-column: 1 / -1; padding: 40px;">
                    <div style="font-size: 2rem; margin-bottom: 20px; animation: spin 1s linear infinite;">‚è≥</div>
                    <h3 style="color: var(--dark); margin-bottom: 10px;">Loading tasks...</h3>
                    <p style="color: var(--gray);">Fetching your latest tasks</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getTasks`, {
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                
                const tasks = await response.json();
                allTasks = tasks || [];
                
                // Filter tasks for current user
                filteredTasks = filterTasksForUser(allTasks, 'my-tasks');
                
                // Update task count badge
                updateTaskBadge();
                
                // Display tasks
                displayTasks(filteredTasks);
                
                // Update stats
                updateStats();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                tasksGrid.innerHTML = `
                    <div style="text-align: center; grid-column: 1 / -1; padding: 40px; color: var(--danger);">
                        <div style="font-size: 3rem; margin-bottom: 20px;">‚ùå</div>
                        <h3 style="color: var(--danger); margin-bottom: 10px;">Failed to load tasks</h3>
                        <p>${error.message}</p>
                        <button onclick="loadTasks()" style="margin-top: 20px;">Retry</button>
                    </div>
                `;
            }
        }

        function filterTasksForUser(tasks, filterType) {
            if (!tasks || tasks.length === 0) return [];
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            
            return tasks.filter(task => {
                // Filter by user selection
                if (filterType === 'my-tasks') {
                    // Check if task is assigned to current user
                    const isAssigned = task.assignedStaff === currentUser;
                    const isFollowingUp = task.followupPerson === currentUser;
                    if (!isAssigned && !isFollowingUp) return false;
                }
                
                // For other filters, we'll implement later
                return true;
            }).sort((a, b) => {
                // Sort by priority: overdue > due today > due soon > others
                const aDue = a.dueDate ? new Date(a.dueDate) : null;
                const bDue = b.dueDate ? new Date(b.dueDate) : null;
                
                if (!aDue && !bDue) return 0;
                if (!aDue) return 1;
                if (!bDue) return -1;
                
                // Overdue first
                if (aDue < today && bDue >= today) return -1;
                if (bDue < today && aDue >= today) return 1;
                
                // Then due today
                if (aDue.getTime() === today.getTime() && bDue.getTime() !== today.getTime()) return -1;
                if (bDue.getTime() === today.getTime() && aDue.getTime() !== today.getTime()) return 1;
                
                // Then due this week
                if (aDue <= weekFromNow && bDue > weekFromNow) return -1;
                if (bDue <= weekFromNow && aDue > weekFromNow) return 1;
                
                // Then by date
                return aDue - bDue;
            });
        }

        function displayTasks(tasks) {
            const tasksGrid = document.getElementById('tasks-grid');
            const selectedForm = document.getElementById('selected-task-form');
            
            if (!tasks || tasks.length === 0) {
                tasksGrid.innerHTML = `
                    <div style="text-align: center; grid-column: 1 / -1; padding: 60px; color: var(--gray);">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üìã</div>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">No tasks found</h3>
                        <p>You're all caught up! üéâ</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Create a new opportunity or check back later.</p>
                    </div>
                `;
                selectedForm.style.display = 'none';
                return;
            }
            
            tasksGrid.innerHTML = '';
            
            tasks.forEach(task => {
                const taskCard = createTaskCard(task);
                tasksGrid.appendChild(taskCard);
            });
            
            selectedForm.style.display = 'none';
        }

        function createTaskCard(task) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const taskDue = task.dueDate ? new Date(task.dueDate) : null;
            const isOverdue = taskDue && taskDue < today;
            const isDueToday = taskDue && taskDue.getTime() === today.getTime();
            const weekFromNow = new Date(today);
            weekFromNow.setDate(weekFromNow.getDate() + 7);
            const isDueSoon = taskDue && taskDue <= weekFromNow && !isDueToday && !isOverdue;
            
            // Determine priority class
            let priorityClass = 'priority-normal';
            let priorityText = 'Normal';
            
            if (isOverdue) {
                priorityClass = 'priority-urgent';
                priorityText = 'URGENT';
            } else if (isDueToday) {
                priorityClass = 'priority-urgent';
                priorityText = 'TODAY';
            } else if (isDueSoon) {
                priorityClass = 'priority-soon';
                priorityText = 'SOON';
            }
            
            // Determine card class
            let cardClass = 'task-card';
            if (isOverdue || isDueToday) cardClass += ' urgent';
            if (task.assignedStaff === currentUser || task.followupPerson === currentUser) {
                cardClass += ' assigned-to-me';
            }
            
            // Format amount
            const amount = task.nairaEstimate ? formatCurrency(parseInt(task.nairaEstimate)) : '‚Ç¶0';
            
            // Format date
            const dueDate = task.dueDate ? formatDate(task.dueDate) : 'No due date';
            
            // Get status display
            const statusDisplay = getStatusDisplay(task.status);
            
            const card = document.createElement('div');
            card.className = cardClass;
            card.innerHTML = `
                <div class="task-priority ${priorityClass}">${priorityText}</div>
                <h3 class="task-client">
                    <span>üè¢</span>
                    ${task.clientName || 'Unknown Client'}
                </h3>
                <div class="task-amount">${amount}</div>
                <div class="task-details">
                    <div class="task-detail">
                        <span class="task-detail-icon">üìÖ</span>
                        <span>${dueDate}</span>
                    </div>
                    <div class="task-detail">
                        <span class="task-detail-icon">üë§</span>
                        <span>${getStaffName(task.assignedStaff)}</span>
                    </div>
                    <div class="task-detail">
                        <span class="task-detail-icon">ü§ù</span>
                        <span>${getStaffName(task.followupPerson)}</span>
                    </div>
                    <div class="task-detail">
                        <span class="task-detail-icon">üìù</span>
                        <span>${task.source || 'Unknown'}</span>
                    </div>
                </div>
                <div class="task-status-badge ${statusDisplay.class}">
                    ${statusDisplay.icon} ${statusDisplay.text}
                </div>
                <div class="task-actions">
                    <button class="action-btn primary" onclick="selectTask('${task.id}', event)">
                        <span>‚úèÔ∏è</span> Update
                    </button>
                    <button class="action-btn" onclick="quickUpdate('${task.id}', 'sent_to_client', event)">
                        <span>üì§</span> Mark Sent
                    </button>
                    <button class="action-btn" onclick="quickUpdate('${task.id}', 'ready_for_review', event)">
                        <span>‚úÖ</span> Ready
                    </button>
                </div>
            `;
            
            // Add click handler for entire card
            card.onclick = (e) => {
                if (!e.target.closest('button')) {
                    selectTask(task.id, e);
                }
            };
            
            return card;
        }

        function selectTask(taskId, event) {
            if (event) event.stopPropagation();
            
            selectedTaskId = taskId;
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Hide tasks grid
            document.getElementById('tasks-grid').style.display = 'none';
            
            // Show selected task form
            const selectedForm = document.getElementById('selected-task-form');
            selectedForm.style.display = 'block';
            
            // Populate form
            document.getElementById('taskId').value = taskId;
            document.getElementById('selected-client').value = task.clientName || '';
            document.getElementById('status').value = task.status || '';
            document.getElementById('nextFollowupDate').value = task.nextFollowupDate || '';
            document.getElementById('notes').value = '';
            
            // Update character counts
            updateCharCount(document.getElementById('notes'), 'notes-count', 1000);
            
            // Scroll to form
            selectedForm.scrollIntoView({ behavior: 'smooth' });
        }

        function deselectTask() {
            selectedTaskId = null;
            document.getElementById('selected-task-form').style.display = 'none';
            document.getElementById('tasks-grid').style.display = 'grid';
            document.getElementById('partner-actions').style.display = 'none';
        }

        function filterTasks(filterType) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter tasks
            filteredTasks = filterTasksForUser(allTasks, filterType);
            
            // Display filtered tasks
            displayTasks(filteredTasks);
        }

        function searchTasks(query) {
            const clearBtn = document.getElementById('clear-search-btn');
            clearBtn.style.display = query ? 'block' : 'none';
            
            if (!query.trim()) {
                displayTasks(filteredTasks);
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const searchedTasks = filteredTasks.filter(task => {
                return (
                    (task.clientName && task.clientName.toLowerCase().includes(searchTerm)) ||
                    (task.status && task.status.toLowerCase().includes(searchTerm)) ||
                    (task.source && task.source.toLowerCase().includes(searchTerm)) ||
                    (task.nairaEstimate && task.nairaEstimate.toString().includes(searchTerm)) ||
                    (task.description && task.description.toLowerCase().includes(searchTerm))
                );
            });
            
            displayTasks(searchedTasks);
        }

        function clearSearch() {
            document.getElementById('task-search').value = '';
            document.getElementById('clear-search-btn').style.display = 'none';
            displayTasks(filteredTasks);
        }

        function refreshTasks() {
            loadTasks();
            showNotification('info', 'Refreshing tasks...', 2000);
        }

        // === PREDICTIVE TYPING ===
        let clientSuggestions = [
            "ABC Corporation",
            "XYZ Enterprises",
            "Global Solutions Ltd",
            "Tech Innovations Inc",
            "Prime Consulting Group",
            "Alpha Financial Services",
            "Beta Manufacturing Co",
            "Gamma Retail Chains",
            "Delta Logistics",
            "Epsilon Technologies"
        ];

        function showClientSuggestions(query) {
            const suggestionsBox = document.getElementById('clientName-suggestions');
            
            if (!query || query.length < 2) {
                suggestionsBox.style.display = 'none';
                return;
            }
            
            const filtered = clientSuggestions.filter(client => 
                client.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filtered.length === 0) {
                suggestionsBox.style.display = 'none';
                return;
            }
            
            suggestionsBox.innerHTML = filtered.map(client => 
                `<div class="suggestion-item" onclick="selectSuggestion('${client}')">${client}</div>`
            ).join('');
            
            suggestionsBox.style.display = 'block';
        }

        function selectSuggestion(clientName) {
            document.getElementById('clientName').value = clientName;
            document.getElementById('clientName-suggestions').style.display = 'none';
            
            // Trigger input event for auto-save
            document.getElementById('clientName').dispatchEvent(new Event('input'));
        }

        // Close suggestions when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#clientName') && !e.target.closest('#clientName-suggestions')) {
                document.getElementById('clientName-suggestions').style.display = 'none';
            }
        });

        // === REAL-TIME AUTO-SAVE ===
        function setupAutoSave() {
            const form = document.getElementById('new-form');
            const fields = form.querySelectorAll('input, select, textarea');
            
            fields.forEach(field => {
                field.addEventListener('input', debounce(saveFormDraft, 1000));
                field.addEventListener('change', debounce(saveFormDraft, 500));
            });
            
            // Check for existing draft every 30 seconds
            setInterval(checkAutoSave, 30000);
        }

        function saveFormDraft() {
            const form = document.getElementById('new-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Check if form has meaningful content
            const hasContent = Object.values(data).some(value => 
                value && value.toString().trim() && 
                !['formType', 'nairaEstimate'].includes(Object.keys(data).find(key => data[key] === value))
            );
            
            if (hasContent) {
                draftData = data;
                localStorage.setItem('newOpportunityDraft', JSON.stringify(data));
                lastSaveTime = new Date();
                
                // Show auto-save indicator
                showAutoSaveIndicator('üíæ Draft saved');
            }
        }

        function loadFormDraft() {
            try {
                const draft = localStorage.getItem('newOpportunityDraft');
                if (draft) {
                    draftData = JSON.parse(draft);
                    
                    // Populate form fields
                    Object.keys(draftData).forEach(key => {
                        const element = document.querySelector(`[name="${key}"]`);
                        if (element) {
                            element.value = draftData[key];
                            
                            // Special handling for Naira estimate
                            if (key === 'nairaEstimate' && element.id === 'nairaEstimate') {
                                const displayField = document.getElementById('nairaEstimateDisplay');
                                if (displayField && draftData[key]) {
                                    const numValue = parseInt(draftData[key]);
                                    if (!isNaN(numValue)) {
                                        displayField.value = new Intl.NumberFormat('en-NG').format(numValue);
                                    }
                                }
                            }
                        }
                    });
                    
                    // Show draft notice
                    document.getElementById('draft-notice').style.display = 'flex';
                    
                    // Update character counts
                    updateCharCount(document.getElementById('description'), 'description-count', 500);
                    
                    showNotification('info', 'Draft restored from last session', 3000);
                }
            } catch (error) {
                console.error('Error loading draft:', error);
                clearDraft();
            }
        }

        function clearDraft() {
            localStorage.removeItem('newOpportunityDraft');
            draftData = null;
            document.getElementById('draft-notice').style.display = 'none';
            document.getElementById('new-form').reset();
            
            // Reset character counts
            updateCharCount(document.getElementById('description'), 'description-count', 500);
            
            showNotification('info', 'Draft cleared', 2000);
        }

        function checkAutoSave() {
            if (lastSaveTime) {
                const now = new Date();
                const diffMinutes = (now - lastSaveTime) / (1000 * 60);
                
                if (diffMinutes > 5) {
                    showAutoSaveIndicator('üïí Auto-save enabled');
                }
            }
        }

        function showAutoSaveIndicator(text) {
            const indicator = document.getElementById('auto-save-indicator');
            const textElement = document.getElementById('auto-save-text');
            
            textElement.textContent = text;
            indicator.style.display = 'flex';
            
            // Hide after 3 seconds
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // === FORM SUBMISSION ===
        function submitNewForm() {
            const form = document.getElementById('new-form');
            
            // Validate form
            if (!validateForm('new-form')) {
                return;
            }
            
            // Get assigned person for notification simulation
            const assignedStaff = document.getElementById('assignedStaff').value;
            const assignedName = getStaffName(assignedStaff);
            
            // Submit form
            handleSubmit('new-form', new Event('submit'));
            
            // Simulate notification (in real app, this would be a push notification)
            if (assignedStaff) {
                setTimeout(() => {
                    const clientName = document.getElementById('clientName').value;
                    const amount = document.getElementById('nairaEstimateDisplay').value;
                    
                    showNotification('info', 
                        `üìã ${assignedName} has been notified about ${clientName} (‚Ç¶${amount})`,
                        5000
                    );
                }, 1500);
            }
        }

        function submitUpdateForm() {
            if (!selectedTaskId) {
                showNotification('error', 'Please select a task first', 3000);
                return;
            }
            
            handleSubmit('update-form', new Event('submit'));
        }

        async function handleSubmit(formId, e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm(formId)) {
                return;
            }
            
            const form = document.getElementById(formId);
            const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');
            const loading = document.getElementById('loading');
            const successBanner = document.getElementById('success-banner');
            const errorBanner = document.getElementById('error-banner');
            
            // Reset banners
            successBanner.className = 'banner success';
            errorBanner.className = 'banner error';
            successBanner.style.display = 'none';
            errorBanner.style.display = 'none';
            
            // Show loading
            loading.style.display = 'block';
            if (submitBtn) submitBtn.disabled = true;
            
            try {
                const formData = new FormData(form);
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Show success
                    let successMessage = result.message || '‚úì Success!';
                    if (!successMessage.includes('‚úì') && !successMessage.includes('‚úÖ')) {
                        successMessage = '‚úì ' + successMessage;
                    }
                    
                    successBanner.textContent = successMessage;
                    successBanner.style.display = 'block';
                    
                    // Clear form if new opportunity
                    if (formId === 'new-form') {
                        form.reset();
                        clearDraft();
                        
                        // Update stats
                        updateStats();
                    }
                    
                    // Reload tasks if update form
                    if (formId === 'update-form') {
                        await loadTasks();
                        deselectTask();
                    }
                    
                    // Hide success after 6 seconds
                    setTimeout(() => {
                        successBanner.style.display = 'none';
                    }, 6000);
                    
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                errorBanner.textContent = `‚úó ${error.message}`;
                errorBanner.style.display = 'block';
                
                // Hide error after 6 seconds
                setTimeout(() => {
                    errorBanner.style.display = 'none';
                }, 6000);
                
            } finally {
                loading.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            }
        }

        // === QUICK ACTIONS ===
        function quickAction(action) {
            if (!selectedTaskId) {
                showNotification('error', 'Please select a task first', 3000);
                return;
            }
            
            const statusSelect = document.getElementById('status');
            const followupDate = document.getElementById('nextFollowupDate');
            
            switch(action) {
                case 'sent':
                    statusSelect.value = 'sent_to_client';
                    showNotification('success', 'Marked as Sent to Client', 2000);
                    break;
                case 'review':
                    statusSelect.value = 'ready_for_review';
                    showNotification('success', 'Marked as Ready for Review', 2000);
                    break;
                case 'followup':
                    // Set follow-up to 3 days from now
                    const threeDaysLater = new Date();
                    threeDaysLater.setDate(threeDaysLater.getDate() + 3);
                    followupDate.value = threeDaysLater.toISOString().split('T')[0];
                    showNotification('success', 'Follow-up scheduled for 3 days from now', 2000);
                    break;
            }
            
            // Trigger change event
            statusSelect.dispatchEvent(new Event('change'));
            followupDate.dispatchEvent(new Event('change'));
        }

        function quickUpdate(taskId, status, event) {
            if (event) event.stopPropagation();
            
            // Find task
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Update task status locally
            task.status = status;
            
            // Update the task card immediately
            const taskCard = document.querySelector(`.task-card[onclick*="${taskId}"]`);
            if (taskCard) {
                const statusBadge = taskCard.querySelector('.task-status-badge');
                const statusDisplay = getStatusDisplay(status);
                statusBadge.className = `task-status-badge ${statusDisplay.class}`;
                statusBadge.innerHTML = `${statusDisplay.icon} ${statusDisplay.text}`;
            }
            
            showNotification('success', `Status updated to ${getStatusDisplay(status).text}`, 2000);
            
            // In a real app, you would also send this to the server
            // For now, we'll just show a notification
            setTimeout(() => {
                showNotification('info', 'Remember to submit the form to save changes', 3000);
            }, 1000);
        }

        // === PARTER SECTION ===
        function togglePartnerSection() {
            const section = document.getElementById('partner-actions');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function toggleCloseFields() {
            const status = document.getElementById('finalStatus').value;
            
            document.getElementById('close-won-fields').style.display = 
                status === 'won' ? 'block' : 'none';
            document.getElementById('close-lost-fields').style.display = 
                status === 'lost' ? 'block' : 'none';
        }

        async function submitCloseTask() {
            const finalStatus = document.getElementById('finalStatus').value;
            
            if (!finalStatus) {
                showNotification('error', 'Please select a final outcome', 3000);
                return;
            }
            
            if (finalStatus === 'won') {
                const actualValue = document.getElementById('actualValue').value;
                if (!actualValue || Number(actualValue) <= 0) {
                    showNotification('error', 'Please enter a valid actual value for Won tasks', 3000);
                    return;
                }
            }
            
            if (finalStatus === 'lost') {
                const lossReason = document.getElementById('lossReason').value;
                if (!lossReason) {
                    showNotification('error', 'Please select a loss reason', 3000);
                    return;
                }
            }
            
            // Prepare form data
            const formData = new FormData();
            formData.append('formType', 'closeTask');
            formData.append('taskId', selectedTaskId);
            formData.append('finalStatus', finalStatus);
            
            if (finalStatus === 'won') {
                formData.append('actualValue', document.getElementById('actualValue').value);
            }
            
            if (finalStatus === 'lost') {
                formData.append('lossReason', document.getElementById('lossReason').value);
                formData.append('lossNotes', document.getElementById('lossNotes').value || '');
            }
            
            // Show loading
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('success', 'Task closed successfully', 3000);
                    
                    // Reset form and hide section
                    document.getElementById('finalStatus').value = '';
                    document.getElementById('actualValue').value = '';
                    document.getElementById('lossReason').value = '';
                    document.getElementById('lossNotes').value = '';
                    document.getElementById('close-won-fields').style.display = 'none';
                    document.getElementById('close-lost-fields').style.display = 'none';
                    document.getElementById('partner-actions').style.display = 'none';
                    
                    // Reload tasks
                    await loadTasks();
                    deselectTask();
                    
                } else {
                    throw new Error(result.message || 'Failed to close task');
                }
                
            } catch (error) {
                showNotification('error', error.message, 5000);
            } finally {
                loading.style.display = 'none';
            }
        }

        // === VALIDATION ===
        function validateForm(formId) {
            let isValid = true;
            const form = document.getElementById(formId);
            
            // Clear previous errors
            clearErrors();
            
            if (formId === 'new-form') {
                // Validate client name
                const clientName = document.getElementById('clientName').value.trim();
                if (!clientName) {
                    showError('clientName', 'Client name is required');
                    isValid = false;
                }
                
                // Validate source
                const source = document.getElementById('source').value;
                if (!source) {
                    showError('source', 'Please select an opportunity source');
                    isValid = false;
                }
                
                // Validate description
                const description = document.getElementById('description').value.trim();
                if (!description) {
                    showError('description', 'Description is required');
                    isValid = false;
                } else if (description.length < 20) {
                    showError('description', 'Description must be at least 20 characters');
                    isValid = false;
                }
                
                // Validate Naira estimate
                const hiddenEstimate = document.getElementById('nairaEstimate').value;
                if (!hiddenEstimate || isNaN(hiddenEstimate) || parseInt(hiddenEstimate) < 50000) {
                    showError('nairaEstimateDisplay', 'Please enter a valid amount (min. ‚Ç¶50,000)');
                    isValid = false;
                }
                
                // Validate assigned staff
                const assignedStaff = document.getElementById('assignedStaff').value;
                if (!assignedStaff) {
                    showError('assignedStaff', 'Please select a Primary Consultant');
                    isValid = false;
                }
                
                // Validate follow-up person
                const followupPerson = document.getElementById('followupPerson').value;
                if (!followupPerson) {
                    showError('followupPerson', 'Please select a Client Relationship Manager');
                    isValid = false;
                }
                
                // Validate due date
                const dueDate = document.getElementById('dueDate').value;
                if (!dueDate) {
                    showError('dueDate', 'Due date is required');
                    isValid = false;
                } else if (!validateDate(dueDate, 'dueDate')) {
                    isValid = false;
                }
            }
            
            if (formId === 'update-form') {
                // Validate status
                const status = document.getElementById('status').value;
                if (!status) {
                    showError('status', 'Please select a status');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        function validateDate(dateString, fieldId) {
            if (!dateString) return true;
            
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (date < today) {
                showError(fieldId, 'Date cannot be in the past');
                return false;
            }
            
            // Optional: Limit to 1 year in future
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() + 1);
            if (date > maxDate) {
                showError(fieldId, 'Date cannot be more than 1 year in the future');
                return false;
            }
            
            return true;
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(`${fieldId}-error`);
            
            if (field) {
                field.classList.add('error-field');
                field.focus();
            }
            
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function clearErrors() {
            document.querySelectorAll('.error-field').forEach(field => {
                field.classList.remove('error-field');
            });
            
            document.querySelectorAll('.error-message').forEach(error => {
                error.style.display = 'none';
            });
        }

        // === STATS UPDATES ===
        function updateStats() {
            // Update new opportunity stats
            const weekCount = Math.floor(Math.random() * 5) + 3;
            const avgValue = Math.floor(Math.random() * 5000000) + 2000000;
            const successRate = Math.floor(Math.random() * 30) + 60;
            
            document.getElementById('week-count').textContent = weekCount;
            document.getElementById('avg-value').textContent = '‚Ç¶' + formatCurrency(avgValue, true);
            document.getElementById('success-rate').textContent = successRate + '%';
            
            // Update similar project value
            document.getElementById('similar-project-value').textContent = 
                '‚Ç¶' + formatCurrency(Math.floor(avgValue * 0.9), true);
            
            // Update task stats
            if (currentUser && allTasks.length > 0) {
                const myTasks = allTasks.filter(task => 
                    task.assignedStaff === currentUser || task.followupPerson === currentUser
                );
                const dueSoon = myTasks.filter(task => {
                    if (!task.dueDate) return false;
                    const due = new Date(task.dueDate);
                    const today = new Date();
                    const weekFromNow = new Date(today);
                    weekFromNow.setDate(weekFromNow.getDate() + 7);
                    return due <= weekFromNow && due >= today;
                });
                const totalValue = myTasks.reduce((sum, task) => 
                    sum + (parseInt(task.nairaEstimate) || 0), 0
                );
                
                document.getElementById('my-task-count').textContent = myTasks.length;
                document.getElementById('due-soon-count').textContent = dueSoon.length;
                document.getElementById('total-value').textContent = '‚Ç¶' + formatCurrency(totalValue, true);
                
                // Update badge
                updateTaskBadge();
            }
        }

        function updateTaskBadge() {
            if (!currentUser || allTasks.length === 0) {
                document.getElementById('update-badge').style.display = 'none';
                return;
            }
            
            const myTasks = allTasks.filter(task => 
                task.assignedStaff === currentUser || task.followupPerson === currentUser
            );
            const urgentTasks = myTasks.filter(task => {
                if (!task.dueDate) return false;
                const due = new Date(task.dueDate);
                const today = new Date();
                const threeDaysFromNow = new Date(today);
                threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);
                return due <= threeDaysFromNow;
            });
            
            if (urgentTasks.length > 0) {
                document.getElementById('update-badge').textContent = urgentTasks.length;
                document.getElementById('update-badge').style.display = 'inline-block';
            } else {
                document.getElementById('update-badge').style.display = 'none';
            }
        }

        // === HELPER FUNCTIONS ===
        function formatCurrency(amount, compact = false) {
            if (!amount) return '0';
            
            if (compact && amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            }
            
            return new Intl.NumberFormat('en-NG').format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-NG', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function getStaffName(staffId) {
            const staff = {
                'staff1': 'Mr. Immanuelson Sam',
                'staff2': 'Ms. Joan Alaribe',
                'staff3': 'Mr. Emmanuel Agama',
                'staff4': 'Mr. Matthew Nnaji',
                'staff5': 'Mr. Peter Esiole'
            };
            return staff[staffId] || 'Unassigned';
        }

        function getStatusDisplay(status) {
            const statusMap = {
                'draft': { icon: 'üìù', text: 'Draft', class: 'status-draft' },
                'ready_for_review': { icon: '‚úÖ', text: 'Ready for Review', class: 'status-ready' },
                'sent_to_client': { icon: 'üì§', text: 'Sent to Client', class: 'status-sent' },
                'client_review': { icon: 'üëÄ', text: 'Client Review', class: 'status-draft' },
                'revise': { icon: 'üîß', text: 'Revise', class: 'status-draft' }
            };
            return statusMap[status] || { icon: '‚ùì', text: 'Unknown', class: 'status-draft' };
        }

        function updateCharCount(textarea, countId, maxLength) {
            const count = textarea.value.length;
            const countElement = document.getElementById(countId);
            countElement.textContent = `${count}/${maxLength} characters`;
            
            if (count > maxLength * 0.9) {
                countElement.className = 'char-count danger';
            } else if (count > maxLength * 0.7) {
                countElement.className = 'char-count warning';
            } else {
                countElement.className = 'char-count';
            }
        }

        function updateDueDateHint() {
            const dateInput = document.getElementById('dueDate');
            const hintElement = document.getElementById('due-date-hint');
            
            if (!dateInput.value) {
                hintElement.textContent = 'Select a date';
                return;
            }
            
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const diffTime = selectedDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                hintElement.textContent = 'Due today';
            } else if (diffDays === 1) {
                hintElement.textContent = 'Due tomorrow';
            } else if (diffDays < 0) {
                hintElement.textContent = `Overdue by ${Math.abs(diffDays)} days`;
            } else {
                hintElement.textContent = `Due in ${diffDays} days (${diffDays/7 < 1 ? '' : Math.floor(diffDays/7) + ' weeks, '}${diffDays%7} days)`;
            }
        }

        function showNotification(type, message, duration = 3000) {
            const banner = document.getElementById(`${type}-banner`);
            banner.textContent = message;
            banner.style.display = 'block';
            
            setTimeout(() => {
                banner.style.display = 'none';
            }, duration);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // === KEYBOARD SHORTCUTS ===
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl + 1 for New Opportunity tab
                if (e.ctrlKey && e.key === '1') {
                    e.preventDefault();
                    showTab('new');
                }
                
                // Ctrl + 2 for Update Task tab
                if (e.ctrlKey && e.key === '2') {
                    e.preventDefault();
                    showTab('update');
                }
                
                // Ctrl + Enter to submit active form
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    const activeTab = document.querySelector('.tab-panel.active');
                    if (activeTab.id === 'new-tab') {
                        submitNewForm();
                    } else if (activeTab.id === 'update-tab' && selectedTaskId) {
                        submitUpdateForm();
                    }
                }
                
                // Escape to deselect task
                if (e.key === 'Escape' && selectedTaskId) {
                    deselectTask();
                }
            });
        }

        // === NAIRA ESTIMATE FORMATTING ===
        document.addEventListener('DOMContentLoaded', function() {
            const displayField = document.getElementById('nairaEstimateDisplay');
            const hiddenField = document.getElementById('nairaEstimate');
            
            if (displayField && hiddenField) {
                displayField.addEventListener('input', function(e) {
                    let rawValue = this.value.replace(/[^\d]/g, '');
                    hiddenField.value = rawValue;
                    
                    if (rawValue) {
                        const numValue = parseInt(rawValue);
                        if (!isNaN(numValue)) {
                            this.value = new Intl.NumberFormat('en-NG').format(numValue);
                        }
                    } else {
                        this.value = '';
                    }
                    
                    // Save draft
                    saveFormDraft();
                });
                
                displayField.addEventListener('paste', function(e) {
                    setTimeout(() => {
                        let rawValue = this.value.replace(/[^\d]/g, '');
                        hiddenField.value = rawValue;
                        if (rawValue) {
                            const numValue = parseInt(rawValue);
                            if (!isNaN(numValue)) {
                                this.value = new Intl.NumberFormat('en-NG').format(numValue);
                            }
                        }
                        saveFormDraft();
                    }, 10);
                });
            }
        });

        // === GOOGLE FORM OPENER ===
        function openGoogleFormDirect() {
            if (!selectedTaskId) {
                showNotification('error', 'Please select a task before uploading documents', 3000);
                return;
            }
            
            const task = allTasks.find(t => t.id === selectedTaskId);
            if (!task) {
                showNotification('error', 'Task not found', 3000);
                return;
            }
            
            const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSe_106ge71JIgvIhzFLiOCf-WMkIB0qb4OboHz3pBWEke_PhA/viewform?usp=pp_url&entry.1694540215=' + 
                           encodeURIComponent(selectedTaskId + ' - ' + (task.clientName || ''));
            
            window.open(FORM_URL, '_blank', 'noopener,noreferrer');
        }

        // Initialize on load
        window.onload = function() {
            console.log('GPMS Fully Loaded');
            // Focus on client name field
            setTimeout(() => {
                const clientNameField = document.getElementById('clientName');
                if (clientNameField && !clientNameField.value) {
                    clientNameField.focus();
                }
            }, 500);
        };
    </script>
</body>
</html>
