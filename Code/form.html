<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Management System</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .tab { display: none; }
        .active { display: block; }
        .banner { padding: 12px; margin: 12px 0; border-radius: 4px; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { display: none; text-align: center; font-size: 1.2em; color: #666; }
        label { display: block; margin: 12px 0 6px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üìã Proposal Management System</h1>
    
    <!-- Tab Navigation -->
    <button onclick="showTab('new')">New Opportunity</button>
    <button onclick="showTab('update')">Update Task</button>
    
    <!-- New Opportunity Tab -->
    <div id="new-tab" class="tab active">
        <h2>New Opportunity (Partners)</h2>
        <form id="new-form">
            <input type="hidden" name="formType" value="newOpportunity">
            
            <label>Client Name:*</label>
            <input type="text" name="clientName" required placeholder="e.g., ABC Corp">
            
            <label>Opportunity Source:*</label>
            <select name="source" required>
                <option value="">Select...</option>
                <option value="existing">Existing Client</option>
                <option value="referral">Referral</option>
                <option value="cold">Cold Outreach</option>
                <option value="partner">Partner Network</option>
                <option value="other">Other</option>
            </select>
            
            <label>Description:*</label>
            <textarea name="description" required rows="4" placeholder="Brief overview of the opportunity..."></textarea>
            
            <label>‚Ç¶ Estimate:*</label>
            <input type="number" name="nairaEstimate" min="0" step="1000" required placeholder="e.g., 5000000">
            
            <label>Assigned Staff:*</label>
            <select name="assignedStaff" required>
                <option value="">Select...</option>
                <option value="staff1">Staff Member 1</option>
                <option value="staff2">Staff Member 2</option>
                <option value="staff3">Staff Member 3</option>
                <option value="staff4">Staff Member 4</option>
                <option value="staff5">Staff Member 5</option>
            </select>
            
            <label>Due Date:*</label>
            <input type="date" name="dueDate" required>
            
            <label>Attach Files (optional, max 40MB each):</label>
            <input type="file" name="attachments" multiple 
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip"
                   onchange="validateFileSize(this)">
            
            <button type="submit">Submit Opportunity</button>
        </form>
    </div>
    
    <!-- Update Task Tab -->
    <div id="update-tab" class="tab">
        <h2>Update Task (Associates)</h2>
        <form id="update-form">
            <input type="hidden" name="formType" value="updateTask">
            
            <label>Select Task:*</label>
            <select name="taskId" required>
                <option value="">Loading tasks...</option>
            </select>
            
            <label>Status:*</label>
            <select name="status" required>
                <option value="">Select...</option>
                <option value="drafting">Drafting</option>
                <option value="review">Review</option>
                <option value="sent">Sent</option>
                <option value="followup">Follow-up</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
                <option value="noresponse">No Response</option>
            </select>
            
            <label>Files / Notes (optional):</label>
            <input type="file" name="updateFiles" multiple 
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip"
                   onchange="validateFileSize(this)">
            <textarea name="notes" rows="3" placeholder="Any additional notes or comments..."></textarea>
            
            <!-- Conditional: Won -->
            <div id="won-fields" style="display:none;">
                <label>‚Ç¶ Actual Value (if Won):*</label>
                <input type="number" name="actualValue" min="0" step="1000">
            </div>
            
            <!-- Conditional: Lost -->
            <div id="lost-fields" style="display:none;">
                <label>Loss Reason:*</label>
                <select name="lossReason">
                    <option value="">Select...</option>
                    <option value="price">Price</option>
                    <option value="competitor">Competitor</option>
                    <option value="timing">Timing</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <!-- Conditional: Follow-up -->
            <div id="followup-fields" style="display:none;">
                <label>Next Follow-up Date:*</label>
                <input type="date" name="nextFollowupDate">
            </div>
            
            <button type="submit">Update Task</button>
        </form>
    </div>
    
    <!-- Banners & Loading -->
    <div id="success-banner" class="banner success" style="display:none;"></div>
    <div id="error-banner" class="banner error" style="display:none;"></div>
    <div id="loading" class="loading">‚è≥ Submitting...</div>
    
    <script>
        // === CONFIG ===
        const SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE';  // ‚Üê Replace this once with your deployed Web App URL

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // File size validation (40MB per file, ~50MB total for GAS safety)
        function validateFileSize(input) {
            const maxPerFile = 40 * 1024 * 1024;
            let total = 0;
            for (let file of input.files) {
                total += file.size;
                if (file.size > maxPerFile) {
                    alert(`"${file.name}" exceeds 40MB. Compress or zip files.`);
                    input.value = '';
                    return;
                }
            }
            if (total > 50 * 1024 * 1024) {
                alert('Total upload size exceeds safe limit (~50MB). Please reduce files.');
                input.value = '';
            }
        }

        // Dynamic conditional fields + required toggling
        document.querySelector('select[name="status"]').addEventListener('change', e => {
            const status = e.target.value;
            
            // Hide all and reset required
            ['won-fields', 'lost-fields', 'followup-fields'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.querySelector('input[name="actualValue"]').required = false;
            document.querySelector('select[name="lossReason"]').required = false;
            document.querySelector('input[name="nextFollowupDate"]').required = false;
            
            if (status === 'won') {
                document.getElementById('won-fields').style.display = 'block';
                document.querySelector('input[name="actualValue"]').required = true;
            } else if (status === 'lost') {
                document.getElementById('lost-fields').style.display = 'block';
                document.querySelector('select[name="lossReason"]').required = true;
            } else if (status === 'followup') {
                document.getElementById('followup-fields').style.display = 'block';
                document.querySelector('input[name="nextFollowupDate"]').required = true;
            }
        });

        // Form submission handler
        async function handleSubmit(formId, formData) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('success-banner').style.display = 'none';
            document.getElementById('error-banner').style.display = 'none';
            const submitBtn = document.querySelector(`#${formId} button[type="submit"]`);
            submitBtn.disabled = true;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    const action = formId === 'new-form' ? 'Opportunity created' : 'Task updated';
                    const message = result.message || `‚úì ${action} successfully!`;
                    document.getElementById('success-banner').textContent = message;
                    document.getElementById('success-banner').style.display = 'block';
                    document.getElementById(formId).reset();
                    setTimeout(() => document.getElementById('success-banner').style.display = 'none', 5000);
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
            } catch (error) {
                document.getElementById('error-banner').textContent = `‚úó ${error.message}`;
                document.getElementById('error-banner').style.display = 'block';
                console.error('Submission error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Attach submit listeners
        document.getElementById('new-form').addEventListener('submit', e => {
            e.preventDefault();
            handleSubmit('new-form', new FormData(e.target));
        });

        document.getElementById('update-form').addEventListener('submit', e => {
            e.preventDefault();
            handleSubmit('update-form', new FormData(e.target));
        });

        // Load tasks for Update dropdown (called on page load)
        async function loadTasks() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getTasks`);
                if (!response.ok) throw new Error('Failed to load tasks');
                const tasks = await response.json();
                const select = document.querySelector('select[name="taskId"]');
                select.innerHTML = '<option value="">Select Task...</option>';
                tasks.forEach(task => {
                    const option = document.createElement('option');
                    option.value = task.id;
                    option.textContent = `${task.clientName || 'Unknown'} - ${task.status || 'N/A'} (Due: ${task.dueDate || 'N/A'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Task load error:', error);
                document.querySelector('select[name="taskId"]').innerHTML = '<option value="">Error loading tasks ‚Äì contact BOM</option>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
        });
    </script>
</body>
</html>